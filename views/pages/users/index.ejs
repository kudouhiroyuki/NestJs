<%- include('../../partials/head'); %>

<body>
<div id="usersIndex" class="container">
  <h4 class="mb-4 fw-bold">
    一覧表示画面
  </h4>

  <div class="mb-4">
    <a href="users/create">新規登録</a>
  </div>

  <div v-if="errors.length" class="alert alert-danger">
    <div v-for="(value, index) in errors" :key="index">
      ■{{ value.property }}エラー
      <p v-for="(i, v) in value.constraints" :key="v">{{ i }}</p>
    </div>
  </div>

  <form name="deleteForm">
    <input type="hidden" name="id">
  </form>

  <form @submit.prevent="onSearch" name="searchForm">
    <input
      @input="onFormChange"
      :value="id"
      type="text"
      name="id"
      placeholder="id"
      class="form-control mb-3"
      style="width: 214px;"
    >
    <button type="submit" class="btn btn-primary" style="width: 156px;">検索</button> 
  </form>

  <table class="table">
    <thead>
      <tr>
        <th>id</th>
        <th>userName</th>
        <th>password</th>
        <th>address</th>
        <th>age</th>
        <th>departmentId</th>
        <th>point</th>
        <th>createdAt</th>
        <th>updateAt</th>
        <th></th>
        <th></th>
        <th></th>
      </tr>
    </thead>
    <tbody>
      <tr v-for="item in users" :key="item.id">
        <td>{{ item.id }}</td>
        <td>{{ item.userName }}</td>
        <td>{{ item.password }}</td>
        <td>{{ item.address }}</td>
        <td>{{ item.age }}</td>
        <td>{{ item.departmentId }}</td>
        <td>{{ item.point }}</td>
        <td>{{ item.createdAt }}</td>
        <td>{{ item.updateAt }}</td>
        <td><a :href=`users/detail/${item.id}` class="btn btn-secondary" style="width: 60px;">詳細</a></td>
        <td><a :href=`users/create?id=${item.id}` class="btn btn-secondary" style="width: 80px;">コピー</a></td>
        <td>
          <button @click="onDelete(item.id)" type="button" class="btn btn-secondary" style="width: 60px;">削除</button> 
        </td>
      </tr>
    </tbody>
  </table>
  <ul>
    <li v-for="(item, index) in pagination" :key="index">{{ index + 1 }}</li>
  </ul>
</div>

<script type="text/javascript">
const errors = `<%- errors %>`;
const users = `<%- users %>`;
const pagination = `<%- pagination %>`;

const queryParam = new URLSearchParams(location.search);

new Vue({
  el: '#usersIndex',
  data: {
    errors: JSON.parse(errors),
    users: JSON.parse(users),
    pagination: JSON.parse(pagination),
    // 検索データ
    id: queryParam.get('id') ?? '',
  },
  created() {
    queryParam.set('id', this.id);
  },
  mounted() {
  },
  methods: {
    /**
     * 検索条件（更新）
     */ 
    onFormChange(e) {
      this[e.target.name] = e.target.value;
      queryParam.set(e.target.name, e.target.value);
    },
    /**
     * 検索処理
     */ 
    onSearch() {
      window.location.href = '/users?' + queryParam;
    },
    /**
     * 削除処理
     */
    onDelete(id) {
      document.deleteForm.id.value = id;
      document.deleteForm.method='post';
      document.deleteForm.action = '/users';
      document.deleteForm.submit();
    },
  }
})
</script>
</body>
</html>
