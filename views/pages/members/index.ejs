<%- include('../../partials/head'); %>

<body>
<div class="layout">
  <%- include('../../partials/header'); %>

  <%- include('../../partials/sidebar'); %>

  <main id="membersIndex">    
    <h4 class="mb-4 fw-bold" style="color:#0069D9;">
      <img src="/images/icon/members.svg" style="width: 24px;">
      会員照会画面
    </h4>

    <!-- 検索フォーム -->
    <form @submit.prevent="onSerch">
      <div :style="serchTabStatus ? 'height: inherit' : 'height: 55px'" class="baseShadow p-3 mb-5 overflow-hidden">
        <div class="d-flex">
          <div class="me-auto"><img src="/images/icon/serchBlue.svg"></div>
          <div style="cursor: pointer">
            <img
              @click="onTabToggle('serchTabStatus')"
              :style="serchTabStatus ? 'transform: inherit' : 'transform: scale(1, -1)'"
              src="/images/icon/arow.svg"
            >
          </div>
        </div>
        <div class="row" style="align-items: flex-end; padding: 2rem 3rem;">
          <div class="col-4 p-0">
            <input
              @input="onFormChange"
              :value="fullName"
              name="fullName"
              type="text"
              class="form-control mb-3"
              placeholder="氏名"
            >
            <input
              @input="onFormChange"
              :value="mail"
              name="mail"
              type="text"
              class="form-control mb-3"
              placeholder="メールアドレス"
            >
            <input
              @input="onFormChange"
              :value="tell"
              name="tell"
              type="text"
              class="form-control"
              placeholder="電話番号"
            >
          </div>
          <div class="col-8 p-0 text-end">
            <button type="submit" class="btn mt-4 baseBtnBlue" style="width: 156px;">
              <img src="/images/icon/serchWhite.svg">
              検索
            </button>
          </div>
          <div v-if="$v.fullName.$dirty || $v.mail.$dirty || $v.tell.$dirty" class="text-danger fw-bold mt-3">
            <p v-if="!$v.fullName.required && !$v.mail.required && !$v.tell.required">氏名、メールアドレス、電話番号のいずれかを入力して下さい。</p>
          </div>
        </div>
      </div>
    </form>

    <!-- 一覧テーブル -->
    <table class="table align-middle mb-5">
      <thead>
        <tr>
          <th scope="col">会員ID</th>
          <th scope="col">入会日</th>
          <th scope="col">氏名</th>
          <th scope="col">メールアドレス</th>
          <th scope="col">電話番号</th>
          <th scope="col">性別</th>
          <th scope="col"></th>
        </tr>
      </thead>
      <tbody>
        <tr v-for="(item, index) in members" :key="index">
          <td>{{ item.memberId }}</td>
          <td>{{ item.joinDate }}</td>
          <td>{{ item.fullName }}</td>
          <td>{{ item.mail }}</td>
          <td>{{ item.tell }}</td>
          <td>{{ item.sex }}</td>
          <td>
            <button type="submit" class="btn baseBtnBlue" style="width: 60px;">
              詳細
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <!-- ページネーション -->
    <nav class="d-flex justify-content-center" aria-label="Page navigation">
      <ul class="pagination mb-0">
        <li :class="{'disabled': Number(pageNumber) === 1}" class="page-item">
          <button
            @click="onPageChange(Number(pageNumber) - 1)"
            type="button"
            class="page-link">Previous
          </button>
        </li>
        <li
          v-for="value of totalPageCount"
          :key="value"
          :class="{'active': value === Number(pageNumber)}"
          class="page-item"
        >
          <button
            @click="onPageChange(value)"
            type="button"
            class="page-link">{{value}}
          </button>
        </li>
        <li :class="{'disabled': Number(pageNumber) === Number(totalPageCount)}" class="page-item">
          <button
            @click="onPageChange(Number(pageNumber) + 1)"
            type="button"
            class="page-link">Next
          </button>
        </li>
      </ul>
    </nav>
  </main>
</div>

<script type="text/javascript">
const members= `<%- members %>`;
const totalPageCount= `<%- totalPageCount %>`;

const queryParam = new URLSearchParams(location.search);

Vue.use(window.vuelidate.default);
const { required, minValue, maxValueValue, minValueValue } = window.validators;

new Vue({
  el: "#membersIndex",
  data: {
    serchTabStatus: true,   // 検索タブ
    // APIデータ
    members: JSON.parse(members),
    totalPageCount: JSON.parse(totalPageCount),
    // 検索データ
    fullName: queryParam.get('fullName') ?? '',
    mail: queryParam.get('mail') ?? '',
    tell: queryParam.get('tell') ?? '',
    pageNumber: queryParam.get('pageNumber') ?? 1,
  },
  created() {
    queryParam.set("fullName", this.fullName);
    queryParam.set("mail", this.mail);
    queryParam.set("tell", this.tell);
    queryParam.set("pageNumber", this.pageNumber);
  },
  validations: {
    fullName: {
      required
    },
    mail: {
      required
    },
    tell: {
      required
    },
  },
  watch: {
  },
  methods: {
    /**
     * アコーディオン（UI）
     */ 
    onTabToggle(target) {
      this[target] = !this[target];
    },
    /**
     * 検索条件（更新）
     */ 
    onFormChange(e) {
      this[e.target.name] = e.target.value;
      queryParam.set(e.target.name, e.target.value);
    },
    // ページ番号（更新）
    onPageChange(page) {
      queryParam.set("pageNumber", page);
      this.onSerch();
    },
    /**
     * 検索処理
     */ 
    onSerch() {
      this.$v.$touch();
      if(!this.$v.fullName.$invalid || !this.$v.mail.$invalid || !this.$v.tell.$invalid) {
        window.location.href = "/members?" + queryParam;
      }
    },
  }
})
</script>
</body>
</html>